{% extends "layout.html" %}

{% block content %}
<h2>Values</h2>

<!-- Form to add or update value -->
<form method="post">
    <input type="hidden" name="account_value_id" id="account_value_id" value="">
    <input type="hidden" name="account_id_hidden" id="account_id_hidden" value="">

    <label>Account:
        <select name="account_id" id="account_id" required>
            {% for account in accounts %}
                <option value="{{ account.id }}">
                    {{ account.name }} - {{ account.owner }} ({{ account.account_number[-4:] }})
                </option>
            {% endfor %}
        </select>
    </label><br>
    
    <label>Date: <input type="date" name="date" id="date" required></label><br>
    <label>Value: <input type="number" step="0.01" name="value" id="value" required></label><br>
    <button type="submit" id="submit_button">Add Value</button>
</form>

<h3>Existing Values</h3>
<table border="1" id="valuesTable">
    <thead>
        <tr>
            <th>Account (Owner & Last 4)</th>
            <th>Institution</th>
            <th>Owner</th>
            <th>Value</th>
            <th>Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="valuesTableBody">
        <!-- Data will be populated by JavaScript -->
    </tbody>
</table>

{% endblock %}

{% block scripts %}
<script>
    function loadAccountValues() {
        fetch('/get_account_values')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('valuesTableBody');
                tableBody.innerHTML = '';  // Clear existing rows
                
                data.forEach(item => {
                    const row = document.createElement('tr');
                    
                    const accountCell = document.createElement('td');
                    accountCell.textContent = `${item.account_name} - ${item.owner} (${item.account_number.slice(-4)})`;
                    row.appendChild(accountCell);
                    
                    const institutionCell = document.createElement('td');
                    institutionCell.textContent = item.institution;
                    row.appendChild(institutionCell);
                    
                    const ownerCell = document.createElement('td');
                    ownerCell.textContent = item.owner;
                    row.appendChild(ownerCell);
                    
                    const valueCell = document.createElement('td');
                    valueCell.textContent = item.value;
                    row.appendChild(valueCell);
                    
                    const dateCell = document.createElement('td');
                    dateCell.textContent = new Date(item.date).toLocaleDateString();
                    row.appendChild(dateCell);

                    const actionCell = document.createElement('td');
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.onclick = function() {
                        editValue(item.id, item.account_id, item.date, item.value);
                    };
                    actionCell.appendChild(editButton);
                    row.appendChild(actionCell);
                    
                    tableBody.appendChild(row);
                });
            });
    }

    function editValue(valueId, accountId, date, value) {
        document.getElementById('account_value_id').value = valueId;
        document.getElementById('account_id_hidden').value = accountId;
        document.getElementById('date').value = new Date(date).toISOString().slice(0, 10);
        document.getElementById('value').value = parseFloat(value.replace(/[^0-9.-]+/g, ""));
        document.getElementById('account_id').value = accountId;
        document.getElementById('account_id').disabled = true;

        document.getElementById('submit_button').textContent = 'Update Value';
    }
    
    document.addEventListener('DOMContentLoaded', loadAccountValues);

    document.querySelector('form').addEventListener('submit', function(event) {
        document.getElementById('account_value_id').value = '';
        document.getElementById('account_id').disabled = false;
        document.getElementById('submit_button').textContent = 'Add Value';
    });
</script>
{% endblock %}